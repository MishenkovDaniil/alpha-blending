# Оптимизация работы Альфа-смешения

***целью данной работы является оптимизация***

***mixing .bmp images using alpha blending method optimizing***

![](/images&font/alpha_blending_result.png?raw=true "Пример альфа-смешения изображений теннисного стола и кота")

## Что такое альфа-смешение

Альфа-смешение - это метод наложения одного изображения на другое, использующее альфа-канал изображения на переднем плане как маску
(альфа-канал определяет степень прозрачности пикселя).

Ниже представлена формула, по которой производились вычисления цвета:
$$mixed.color = foreground.color \cdot foreground.alpha + background.color \cdot (1 - foreground.alpha),$$
где foreground_alpha - значение в интервале от 0 до 1, прямо пропорционально зависящее от значения альфа-канала.


## Стадии работы

Для анализа времени работы программы в том или ином случае было написано несколько версий программы, осузествляющей альфа-смешение.

Каждая версия придерживается следующей структуры:
1. Получение начальных изображений.
2. Создание заготовки под изображение - результат выполнения программы, представляющей собой копию изображения на заднем плане.
3. Конвертирование пикселей в нужной части изображения по формуле выше.
4. Конвертирование полученного изображения в нужный формат, если необходимо.

### Наивная версия

Наивная версия ([naive version link](/implementation_versions/alpha_blending_0.cpp)) работает с SFML структурой Image и обращается к ней каждый раз, когда необходимо получить или загрузить пиксель. Это значительно сокращает время работы алгоритма, но простота кода программы позволяет увидеть алгоритм реализации альфа-смешения наиболее ярко.

### Обычная версия

Эта версия ([ordinary version link](/implementation_versions/alpha_blending_1.cpp)) работает с массивами пикселей, что позволяет обращаться к ним гораздо быстрее, чем в случае наивной версии. Также следует отметить, что теперь необходимо конвертировать изображения из BGRA формата (формат .bmp файлов) в RGBA формат (формат, требуемый для создания изображения в SFML).

### Оптимизированная версия

Оптимизированная версия ([optimized version link](/implementation_versions/alpha_blending_2.cpp)) представляет собой предыдущую версию, в которой вычисления с пикселями проводятся с использованием интринсик-функции, что позволяет вычислить несколько пикселей итогового изображения одновременно. Мы используем SSE инструкции для работы с 128-битными XMM регистрами, что позволяет вычислять 4 пикселя за одну итерацию.

**Замечание: в программе альфа-смешения были оптимизированы только преобразования, преобразующие цвет итогового пикселя, и мы замеряли только их время работы**

## Время работы

Некоторые важные замечания:
- рабочий фпс измерялся без учета отрисовки и вычислялся как обратная величина ко времени работы (в секундах)
- среднее время измерялось посредством многократного запуска программы и усреднения результата (10000 запусков в случае наивной версии и 100000 в других)
- все версии запускались с флагом оптимизации -O3

| Версия                    | ФПС   | Коэффициент ускорения |
| ------------------------- | ----- | --------------------- |
| naive                     | 484   |    0.32               |
| not_optimized             | 1495  |    0                  |    
| optimized                 | 4415  |    3.95               |

## Выводы

- Использование интринсик-функций ускоряет работу программы в тех местах, где необходимо проводить одинаковые действия с несколькими независимыми обьектами.
- На практике, накладные расходы не позволяют достигнуть абсолютного ускорения работы программы: обрабатывая в 4 раза больше пикселей за одну итерацию с помощью XMM регистров мы получили ускорение только в 3 раза (в сравнении с обычной версией). 